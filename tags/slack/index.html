<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-US">
  <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title>slack &middot; The Butler</title>
    <meta name="description" content="A ready to use static blog, powered by Cecil." />
    <meta name="keywords" content="Cecil, Static Site Generator, SSG" />
    <meta name="author" content="Arnaud Ligny" />
    <link rel="canonical" type="text/html" title="slack &middot; The Butler" href="/tags/slack/" />
    <link rel="alternate" type="application/atom+xml" title="slack &middot; The Butler (ATOM)" href="/tags/slack/atom.xml" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:site_name" content="The Butler" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="slack &middot; The Butler" />
    <meta property="og:description" content="A ready to use static blog, powered by Cecil." />
    <meta property="og:url" content="/tags/slack/" />
    <meta name="twitter:card" content="summary" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.2ed26c8c43c597e80160a75eaf1fda79.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
    <link rel="stylesheet" href="/css/monokai-sublime.0c8b4c0e8a584e7142b08d914644cd9d.min.css">
    <script src="/js/highlight-9.13.1.min.2fa064f94c70848f3999ad3402ca49c8.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <meta name="generator" content="Cecil 5.42.5" />
  </head>
  <body class="">
    <div class="sidebar">
      <div class="container  sidebar-sticky">
        <div class="sidebar-about">
          <h1>
            <a href="/">The Butler</a>
          </h1>
          <p class="lead">A ready to use static blog, powered by Cecil.</p>
        </div>
        <nav class="sidebar-nav">
          <a class="sidebar-nav-item item-weight-0" href="/">Home</a>
          <a class="sidebar-nav-item item-weight-100" href="/blog/">Blog</a>
          <a class="sidebar-nav-item item-weight-999" href="/about/">About</a>
        </nav>
        <p>Powered by <a href="https://cecil.app/#5.42.5">Cecil</a> &amp; <a href="https://github.com/poole/hyde#readme">Hyde</a>.</p>
      </div>
    </div>
    <div class="content container">
      <div class="posts">
        <div class="post">
          <h1 class="post-title">
            <a href="/blog/sending-slack-messages-in-python/">Sending Slack Messages in Python</a>
          </h1>
          <span class="post-date">25 Mar 2021</span>
          <p>In this post I will demonstrate how to send messages to slack using python based on the status of an event. </p>
<p>We will keep it basic, that when something is down or up, it should send a slack message with the status, message, color and embed your grafana dashboard links inside the alert (or any links that you would like).</p>
<h2>Create a Webhook</h2>
<p>From a previous post on <a href="https://blog.ruanbekker.com/blog/2019/04/18/setup-a-slack-webhook-for-sending-messages-from-applications/">how to use curl to send slack messages</a> I showed how to create your webhook, so you can just follow that post if you want to follow along.</p>
<p>Once you have a webhook, which will look like <code>https://hooks.slack.com/services/xx/yy/zz</code>, you are good to follow to the next step.</p>
<h2>Creating the Script</h2>
<p>First we need requests:</p>
<pre><code>$ pip install requests</code></pre>
<p>Then we will create the <code>slack_notifier.py</code>, just ensure that you replace your slack webhook url and slack channel to yours:</p>
<pre><code class="language-python">import requests
import sys
import os

SLACK_WEBHOOK_URL = 'https://hooks.slack.com/&lt;your&gt;/&lt;slack&gt;/&lt;webhook&gt;'
SLACK_CHANNEL = "#your-slack-channel"
ALERT_STATE = sys.argv[1]

alert_map = {
    "emoji": {
        "up": ":white_check_mark:",
        "down": ":fire:"
    },
    "text": {
        "up": "RESOLVED",
        "down": "FIRING"
    },
    "message": {
        "up": "Everything is good!",
        "down": "Stuff is burning!"
    },
    "color": {
        "up": "#32a852",
        "down": "#ad1721"
    }
}

def alert_to_slack(status, log_url, metric_url):
    data = {
        "text": "AlertManager",
        "username": "Notifications",
        "channel": SLACK_CHANNEL,
        "attachments": [
        {
            "text": "{emoji} [*{state}*] Status Checker\n {message}".format(
                emoji=alert_map["emoji"][status],
                state=alert_map["text"][status],
                message=alert_map["message"][status]
            ),
            "color": alert_map["color"][status],
            "attachment_type": "default",
            "actions": [
                {
                    "name": "Logs",
                    "text": "Logs",
                    "type": "button",
                    "style": "primary",
                    "url": log_url
                },
                {
                    "name": "Metrics",
                    "text": "Metrics",
                    "type": "button",
                    "style": "primary",
                    "url": metric_url
                }
            ]
        }]
    }
    r = requests.post(SLACK_WEBHOOK_URL, json=data)
    return r.status_code

alert_to_slack(ALERT_STATE, "https://grafana-logs.dashboard.local", "https://grafana-metrics.dashboard.local")</code></pre>
<h2>Testing it out</h2>
<p>Time to test it out, so let's assume something is down, then we can react on that event and action the following:</p>
<pre><code>$ python slack_notifier.py down</code></pre>
<p>Which will look like the following on slack:</p>
<p><img src="https://user-images.githubusercontent.com/567298/98374881-fdf00880-2049-11eb-9d7f-7599665871db.png" alt="image" width="461" loading="lazy" /></p>
<p>And when recovery is in place, we can action the following:</p>
<pre><code>$ python slack_notifier.py up</code></pre>
<p>Which will look like this:</p>
<p><img src="https://user-images.githubusercontent.com/567298/98374958-1eb85e00-204a-11eb-8ab0-c6a8a0640752.png" alt="image" width="471" loading="lazy" /></p>
<h2>Thanks</h2>
<p>That was a basic example on how you can use python to send slack messages.</p>
        </div>
      </div>
    </div>
  </body>
</html>
